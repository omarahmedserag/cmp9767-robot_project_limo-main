#!/usr/bin/env python3
"""
Long waypoint tour for rally_obstacle5.world
66 goals + home – drives through every free corridor and returns home.
"""
import rclpy
import math
from geometry_msgs.msg import PoseStamped
from nav2_simple_commander.robot_navigator import BasicNavigator, TaskResult

# ------------------------------------------------------------------
# helper
# ------------------------------------------------------------------
def make_pose(navigator, x, y, yaw):
    qz = math.sin(yaw / 2.0)
    qw = math.cos(yaw / 2.0)
    pose = PoseStamped()
    pose.header.frame_id = 'map'
    pose.header.stamp = navigator.get_clock().now().to_msg()
    pose.pose.position.x = x
    pose.pose.position.y = y
    pose.pose.orientation.z = qz
    pose.pose.orientation.w = qw
    return pose

# ------------------------------------------------------------------
# main
# ------------------------------------------------------------------
def main():
    rclpy.init()
    navigator = BasicNavigator()

    # 1. Initial pose (matches Gazebo spawn)
    initial_pose = make_pose(navigator, 0.0, 0.0, 0.0)
    navigator.setInitialPose(initial_pose)
    navigator.waitUntilNav2Active()

    # 2. Clear cost-maps and wait for propagation
    navigator.clearAllCostmaps()
    navigator.waitUntilNav2Active()

    # 3. 66 way-points (all in free space)
    waypoints = [
        (-7.09269380569458, 1.3065967559814453, -2.513579965948582),
        (-7.403512954711914, -2.6324281692504883, -2.245205437831945),
        (-7.022441864013672, -3.01169490814209, -2.318116754302978),
        (-8.458209037780762, -5.6326398849487305, -2.437934473958333),
        (-6.96444845199585, -6.58509635925293, -2.357327859426215),
        (-7.904035568237305, -5.04749870300293, -2.409472956949869),
        (-7.678519248962402, -6.515252113342285, -2.498714649245563),
        (-7.534152984619141, -8.183809280395508, -2.428060927097943),
        (-6.795192241668701, -7.98647403717041, -1.816245037554810),
        (-6.173465728759766, -7.527381896972656, -1.890095214605637),
        (-3.4289286136627197, -8.61904525756836, 0.041378777711048),
        (-0.8360147476196289, -8.56640625, 0.662831370178868),
        (0.6339612007141113, -8.441990852355957, 0.213202209320923),
        (1.413097858428955, -9.108893394470215, 0.381470577893844),
        (5.457695007324219, -9.107524871826172, 0.387253786015061),
        (7.193860054016113, -8.44328498840332, 0.917137879077411),
        (7.439838409423828, -9.77067756652832, 0.749788924333684),
        (7.942437171936035, -8.24099349975586, 1.138801940273838),
        (8.139883995056152, -8.657205581665039, 1.04670268222673),
        (7.917063236236572, -7.850122451782227, 1.137399696495536),
        (8.599862098693848, -8.895000457763672, -0.322947805464754),
        (9.320435523986816, -7.767177581787109, 1.557602881547676),
        (8.845309257507324, -7.401166915893555, 1.713602848963508),
        (7.707035541534424, -4.671480178833008, 1.568389166279015),
        (8.396851539611816, -6.176023483276367, 1.764753590888794),
        (7.382174968719482, -5.219003677368164, 1.672021161279559),
        (7.227493762969971, -5.226737022399902, 1.614545140279099),
        (5.674519062042236, -1.1546440124511719, 1.621833044278198),
        (7.809882164001465, -6.6136627197265625, 1.618654804557136),
        (7.052889347076416, -5.981635093688965, 1.41157127827897),
        (5.702394485473633, -2.9778738021850586, 1.759148849557616),
        (7.032761573791504, -3.180710792541504, 1.709902713914531),
        (7.6723551750183105, -4.482295989990234, 1.573498764278031),
        (7.11886739730835, -5.552362442016602, 1.624525982558518),
        (7.364345550537109, -3.9078540802001953, 1.686480823156266),
        (5.479437351226807, -3.655872344970703, 1.641021246556533),
        (4.728377342224121, -1.5284290313720703, 1.671020493113106),
        (8.700812339782715, -4.3999481201171875, 1.623945092269846),
        (7.567436218261719, -6.039774417877197, 0.960704974148921),
        (7.548259735107422, -6.116436004638672, 0.830389691369531),
        (8.326214790344238, -4.236313819885254, 1.317043665646134),
        (7.957436561584473, -3.7238922119140625, 1.641864309280452),
        (7.294888973236084, -1.6844987869262695, 1.702472970401208),
        (6.132051944732666, -1.76458740234375, 1.757995421473843),
        (5.234365463256836, -2.8109922409057617, 1.711144848963808),
        (4.651050567626953, -1.8002376556396484, 1.703021147093469),
        (4.76328706741333, -1.7720651626586914, 1.729870146614761),
        (5.268190860748291, -1.2704458236694336, 1.019125550490903),
        (6.715663909912109, -0.5831003189086914, 1.300781117625240),
        (7.438680171966553, 0.6896467208862305, 1.715589176926133),
        (7.366388320922852, 2.1458072662353516, 1.773026397783507),
        (2.4416303634643555, 1.2121829986572266, -2.994480547614515),
        (-0.21697759628295898, -1.2045421600341797, 2.116297482542207),
        (-1.6047282218933105, -0.8034858703613281, 2.119829386082139),
        (-1.2197623252868652, -0.6433010101318359, 2.140589901256357),
        (-1.888063907623291, -3.6516666412353516, -1.712574725283020),
        (-0.6154994964599609, -4.410371780395508, 1.301591583445557),
        (-1.2849082946777344, 2.253490447998047, 1.635306688941289),
        (-1.0440945625305176, 2.0027637481689453, 1.714601008600051),
        (-1.9005732536315918, 2.218003273010254, 1.652057657944147),
        (-1.5192465782165527, 2.867826461791992, 1.764078423439397),
        (-0.8574748039245605, 0.7970924377441406, 1.075555037742529),
        (-0.6990694999694824, 2.577362060546875, 0.963511585725987),
        (-0.41179466247558594, 0.3806743621826172, -0.875433326511376),
        (0.0, 0.0, 0.0)  # home
    ]

    poses = [make_pose(navigator, x, y, yaw) for x, y, yaw in waypoints]

    # 4. Execute
    print('Sending LONG waypoint request …')
    navigator.followWaypoints(poses)
    while not navigator.isTaskComplete():
        feedback = navigator.getFeedback()
        if feedback:
            print(f'Executing waypoint {feedback.current_waypoint + 1}/{len(poses)}')

    # 5. Result
    result = navigator.getResult()
    if result == TaskResult.SUCCEEDED:
        print(' Long tour complete!')
    elif result == TaskResult.CANCELED:
        print(' Canceled')
    else:
        print(' Failed')

    rclpy.shutdown()

if __name__ == '__main__':
    main()